---
- name: Check if cluster consist of at least 2 nodes
  fail: msg="Cluster must have at least 2 members"
  when: play_hosts|count() < 2

- name: Install libselinux-python to work with SELinux setting
  yum: name=libselinux-python state=installed

- name: Generate /etc/hosts
  template:
    src=hosts.j2
    dest=/etc/hosts

- name: Install rgmanager cluster packages to all nodes
  yum: name={{ item }} state=installed
  with_items: 
    - "{{ rgmanager_packages }}"

- name: Create 'ricci' system group for cluster
  group: name={{ cluster_group }} state=present
- name: Create 'ricci' user for cluster
  user: 
    name={{ cluster_user }} state=present
    password={{ cluster_user_pass | password_hash('sha512', ansible_hostname|replace('-','x')) }}

- name: Enable and start ricci service
  service: name=ricci enabled=yes state=started

- name: Setup iptables firewall
  include: firewall.yml
  when: cluster_firewall == true

- name: create /etc/cluster directory
  file: path=/etc/cluster state=directory

- name: Copy fence_xvm key
  copy: src=/etc/cluster/fence_xvm.key dest=/etc/cluster/fence_xvm.key owner=root group=root mode=0640
  when: cluster_configure_fence_xvm == true

- name: Generate and copy /etc/cluster/cluster.conf
  template:
    src=cluster.conf.rgmanager.j2
    dest=/etc/cluster/cluster.conf
#    validate='ccs_config_validate -f %s'

- name: Start cluster services on all nodes
  service: name={{ item }} state=started
  with_items:
    - cman
    - rgmanager

- name: Enable cluster services on boot
  service: name={{ item }} enabled=yes
  when: cluster_enable_service == true
  with_items:
    - cman
    - rgmanager
